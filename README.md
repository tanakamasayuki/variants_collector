# variants_collector

[English](README.md) | [日本語](README.ja.md)

`variants_collector` is a header-only Arduino library that provides board metadata and pin definitions as `constexpr` values.

This library is intended for projects that:

- run the same firmware binary on multiple boards
- detect the board at runtime (for example, M5Unified-like workflows)
- then reference the correct board/variant definitions safely

## Features

- header-only (`src/variants_collector.h` only)
- no dynamic allocation
- no runtime dependency
- generated from Board Manager package indexes and platform archives

## Installation

### Arduino Library Manager

1. Open Arduino IDE
2. Open `Tools > Manage Libraries...`
3. Search `variants_collector`
4. Install

### Manual

1. Download this repository as ZIP
2. In Arduino IDE, open `Sketch > Include Library > Add .ZIP Library...`
3. Select the ZIP file

## Usage

```cpp
#include <variants_collector.h>

void setup() {
  Serial.begin(115200);

  // Select one definition after your runtime board detection step.
  namespace Board = variants_collector::esp32::esp32::m5stack_atoms3;

  Serial.println(Board::Info::fqbn);
  Serial.println(Board::Info::name);
  Serial.println(Board::Info::build_mcu);
  Serial.println(Board::Pins::boot_btn);
}

void loop() {}
```

## Namespace Access Patterns

### 1. Fully-qualified access

```cpp
#include <variants_collector.h>

void setup() {
  Serial.begin(115200);
  Serial.println(variants_collector::esp32::esp32::m5stack_atoms3::Info::fqbn);
  Serial.println(variants_collector::esp32::esp32::m5stack_atoms3::Pins::boot_btn);
}
```

### 2. Namespace alias for the board (local scope)

```cpp
#include <variants_collector.h>

void setup() {
  Serial.begin(115200);
  namespace Board = variants_collector::esp32::esp32::m5stack_atoms3;
  Serial.println(Board::Info::fqbn);
  Serial.println(Board::Pins::boot_btn);
}
```

### 3. Namespace alias for shorter board names (local scope)

```cpp
#include <variants_collector.h>

void setup() {
  Serial.begin(115200);
  namespace vc = variants_collector::esp32::esp32;
  Serial.println(vc::m5stack_atoms3::Info::fqbn);
  Serial.println(vc::m5stack_atoms3::Pins::boot_btn);
}
```

### 4. Type alias for specific members (local scope)

```cpp
#include <variants_collector.h>

void setup() {
  Serial.begin(115200);
  using BoardInfo = variants_collector::esp32::esp32::m5stack_atoms3::Info;
  using BoardPins = variants_collector::esp32::esp32::m5stack_atoms3::Pins;
  Serial.println(BoardInfo::fqbn);
  Serial.println(BoardPins::boot_btn);
}
```

### 5. using namespace (least recommended, local scope)

```cpp
#include <variants_collector.h>

void setup() {
  Serial.begin(115200);
  using namespace variants_collector::esp32::esp32;
  Serial.println(m5stack_atoms3::Info::fqbn);
  Serial.println(m5stack_atoms3::Pins::boot_btn);
}
```

Reason: `using namespace` makes many board names visible at once, which increases the
risk of name collisions with other libraries or future additions. Prefer a type
alias or a namespace alias to keep scope tight.

## Runtime Auto-Detection Integration Pattern

This library does not perform board detection by itself.
Use your own runtime detection and then map to one board definition namespace.

1. Detect current board at runtime
2. Select the matching definition namespace in `variants_collector`
3. Access `Info`/`Pins` constants

See `examples/RuntimeSelection/RuntimeSelection.ino`.

## Data Generation

Source data is generated by scripts in `tools/`.

```bash
php tools/collect.php
php tools/merge.php
php tools/generate_overrides_m5.php
php tools/merge.php
php tools/generate_header.php
```

Default package indexes are defined in `tools/config.php`.

### Overrides

You can override or add pin definitions per FQBN using override files in `tools/`.
Overrides are applied in order: `tools/overrides_m5.json` first, then `tools/overrides.json`.
If a pin name already exists, it is overwritten. If it does not exist, it is added.

`tools/overrides_m5.json` can be auto-generated from M5Unified:

```bash
php tools/generate_overrides_m5.php
```

Example:

```json
{
  "esp32:esp32:m5stack_atoms3": {
    "pins": {
      "builtin_led": { "type": "uint8_t", "value": 38 },
      "user_led": 39
    },
    "info": {
      "name": "M5Stack Atom S3 (override example)",
      "build_mcu": "esp32s3"
    }
  }
}
```

Override file paths are configured in `tools/config.php` as `overrides_paths`.

## License

MIT License. See `LICENSE`.
